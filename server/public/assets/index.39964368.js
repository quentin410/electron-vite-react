var e=Object.defineProperty,a=Object.prototype.hasOwnProperty,t=Object.getOwnPropertySymbols,l=Object.prototype.propertyIsEnumerable,n=(a,t,l)=>t in a?e(a,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[t]=l,r=(e,r)=>{for(var o in r||(r={}))a.call(r,o)&&n(e,o,r[o]);if(t)for(var o of t(r))l.call(r,o)&&n(e,o,r[o]);return e};import{r as o,a as s,A as i,S as c,E as d,C as m,b as p,u,M as w,W as E,F as g,J as y,d as v,c as b,e as N,I as h,B as A,P as S,f as _,g as C,R as f,o as I,h as k}from"./vendor.7ee6efbc.js";!function(e=".",a="__import__"){try{self[a]=new Function("u","return import(u)")}catch(t){const l=new URL(e,location),n=e=>{URL.revokeObjectURL(e.src),e.remove()};self[a]=e=>new Promise(((t,r)=>{const o=new URL(e,l);if(self[a].moduleMap[o])return t(self[a].moduleMap[o]);const s=new Blob([`import * as m from '${o}';`,`${a}.moduleMap['${o}']=m;`],{type:"text/javascript"}),i=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(s),onerror(){r(new Error(`Failed to import: ${e}`)),n(i)},onload(){t(self[a].moduleMap[o]),n(i)}});document.head.appendChild(i)})),self[a].moduleMap={}}}("/assets/");const O={materials:[],materialNewModalVisible:!1,settingModalVisible:!1,debugModalVisible:!1,localMaterials:[],currentState:"materialCenter",pi:"",modules:[],pageData:{},debugMaterialKey:""},M=(e,a)=>{switch(a.type){case"CHANGE_COMPILE_STATUS":return r(r({},e),a.payload);case"UPDATE_LOCAL_MATERIALS":return r(r({},e),{localMaterials:a.payload});case"UPDATE_DEBUG_MATERIAL_KEY":return r(r({},e),{debugMaterialKey:a.payload});case"UPDATE_PI":return r(r({},e),{pi:a.payload});case"UPDATE_MODULES":return r(r({},e),{modules:a.payload});case"UPDATE_PAGEDATA":return r(r({},e),{pageData:a.payload});case"CHANGE_APP_STATE":return r(r({},e),{currentState:a.payload});case"GET_MATERIALS":return r(r({},e),{materials:a.payload});case"CHANGE_MATERIAL_NEW_MODAL":return r(r({},e),{materialNewModalVisible:a.payload});case"CHANGE_SETTING_MODAL":return r(r({},e),{settingModalVisible:a.payload});case"CHANGE_DEBUG_MODAL":return r(r({},e),{debugModalVisible:a.payload});case"SHOW_LOCAL_MATERIALS":return r(r({},e),{localMaterials:a.payload});default:return e}},T=o.createContext(null);const L=s.create({baseURL:"/api"});L.interceptors.response.use((function(e){return null==e?void 0:e.data}),(function(e){return{code:-1,value:e}}));const{Meta:P}=m;var D=e=>{const{data:{name:a,repository:t,screenshot:l,material_key:n,creator:r,creator_workid:s}}=e,[u,w]=o.useContext(T),E=()=>{w({type:"CHANGE_DEBUG_MODAL",payload:!0}),w({type:"UPDATE_DEBUG_MATERIAL_KEY",payload:n})},g=async e=>{const a=await L.post("materials/download",{material_key:n,repository:e.repository,workspace:window.localStorage.getItem("workspace")});if(0===a.code)window.dbPromise.then((async a=>{const t={name:e.name,screenshot:e.screenshot,id:e.id,material_key:e.material_key,creator:e.creator,creator_workid:e.creator_workid};try{await a.add("local-materials",t)}catch(n){}const l=await a.getAll("local-materials");w({type:"UPDATE_LOCAL_MATERIALS",payload:l});p.open({message:"下载成功",description:"请切换到本地物料进行调试",duration:2})}));else{const e={message:"下载失败",description:a.value,duration:2};p.open(e)}},y=()=>{var e;const a=window.localStorage.getItem("workspace")+"/"+n;console.log(12333,a),null==(e=null==window?void 0:window.api)||e.send("vscode",a)},v=()=>{var e;const a=window.localStorage.getItem("workspace")+"/build";console.log(12333,a),null==(e=null==window?void 0:window.api)||e.send("vscode",a)};let b=[];return b=e.isLocal?[o.createElement("img",{onClick:E,className:"debug-icon",src:"https://gw.alicdn.com/imgextra/i3/O1CN01vGzwpp1aBmXyMAMd0_!!6000000003292-2-tps-200-200.png"}),o.createElement("img",{onClick:y,className:"editor-icon",src:"https://img.alicdn.com/imgextra/i3/O1CN01vYVHPQ1hVCekKT8Ta_!!6000000004282-2-tps-200-200.png"}),o.createElement("img",{onClick:v,className:"editor-icon",src:"https://img.alicdn.com/imgextra/i3/O1CN01vYVHPQ1hVCekKT8Ta_!!6000000004282-2-tps-200-200.png"})]:[o.createElement(i,{key:"edit",onClick:g.bind(null,e.data)}),o.createElement(c,{key:"setting"}),o.createElement(d,{key:"ellipsis"})],o.createElement(m,{style:{width:300},className:"material-card-box",cover:o.createElement("img",{alt:"example",src:l||"http://gw.alicdn.com/tfs/TB17i4.LNTpK1RjSZFMXXbG_VXa-128-128.png",className:"cover-img"}),actions:b},o.createElement(P,{title:a,description:n}),o.createElement("div",{className:"creator"},"开发：",r,"(",s,")"))},G=e=>{var a;const[t,l]=o.useContext(T);return o.useEffect((()=>{(async()=>{const e=await L.get("/materials?type=1");l({type:"GET_MATERIALS",payload:e.value})})()}),[]),o.createElement("div",{className:"center-wrapper container-item"},o.createElement("div",{className:"title"},"线上物料"),o.createElement("div",{className:"material-card-wrapper"},null==(a=null==t?void 0:t.materials)?void 0:a.map(((e,a)=>o.createElement(D,{data:e,key:a})))))};const U={displayType:"row",showDescIcon:!0,labelWidth:120,type:"object","ui:displayType":"row","ui:showDescIcon":!0,properties:{title:{title:"标题",type:"string",required:!0,"ui:options":{},placeholder:"请输入标题"},type:{title:"类型",type:"string",enum:["0","1"],enumNames:["模块","PI"],default:"0"},material_key:{required:!0,title:"唯一标识",type:"string","ui:options":{},placeholder:"请输入唯一标识"},description:{title:"描述",type:"string","ui:options":{},placeholder:"请输入描述"},screenshot:{title:"截图",type:"string","ui:options":{},description:"",default:"",placeholder:"请输入截图地址"}}},x=()=>{const[e,a]=o.useContext(T),t=u();return o.createElement(w,{visible:!0,width:800,onOk:()=>t.submit(),onCancel:()=>a({type:"CHANGE_MATERIAL_NEW_MODAL",payload:!1})},o.createElement(E,{form:t,schema:U}))};const R={labelCol:{span:2},wrapperCol:{span:22}},{Option:j}=b,H={wrapperCol:{offset:2,span:22}},V=()=>{const e=window.localStorage.getItem("lastDebugObj"),a=e?JSON.parse(e).pi:"",t=e?JSON.parse(e).modules:[],l=e?JSON.parse(e).pageId:"",n=e?JSON.parse(e).selectedAppId:null,[s,i]=o.useState(n),[c,d]=o.useState(l),[m,p]=o.useContext(T),[u,E]=o.useState(!1),[h,A]=o.useState([]),[S,_]=o.useState([]),[C,f]=o.useState([]),[I,k]=o.useState([]),[O,M]=o.useState(null),[P]=g.useForm(),D=()=>p({type:"CHANGE_DEBUG_MODAL",payload:!1});o.useEffect((()=>{const e=document.getElementById("jsoneditor");if(e&&!O){const a=new y(e,{mode:"code"});M(a)}L.get("applications?type=0").then((e=>{_(e.value)})),L.get("materials?type=0").then((e=>{const a=e.value.map((e=>({label:e.name,value:e.material_key})));A(a)})),L.get("materials?type=1").then((e=>{const a=e.value.map((e=>({label:e.name,value:e.material_key})));k(a)})),s&&L.get(`pages?applicationId=${s}`).then((e=>{f(e.value)}))}),[]);const G=o.useRef(0),U=o.useMemo((()=>v((e=>{if(!e)return;G.current+=1;const a=G.current;E(!0),e&&L.get("materials",{params:{keyword:e,type:0}}).then((e=>{if(a!==G.current)return;E(!1);const t=e.map((e=>({label:e.name,value:e.material_key})));A(t)}))}),800)),[]),x=o.useMemo((()=>v((e=>{if(!e)return;G.current+=1;const a=G.current;E(!0),e&&L.get("materials",{params:{keyword:e,type:1}}).then((e=>{if(a!==G.current)return;E(!1);const t=e.value.map((e=>({label:e.name,value:e.material_key})));k(t)}))}),800)),[]);return console.log(11111,a),o.createElement(w,{className:"debug-modal-wrapper",visible:m.debugModalVisible,width:800,onOk:()=>{P.submit()},onCancel:D},o.createElement(g,r(r({},R),{onFinish:e=>{var a;const t={container:{npm:`@ali/${e.pi}`,version:"latest",initialParams:JSON.parse(C.find((a=>a.id===e.pageId)).initial_params)},components:e.modules&&e.modules.map((e=>({npm:`@ali/${e}`,version:"latest",debug:!1}))).concat({npm:`@ali/${m.debugMaterialKey}`,version:"latest",debug:!0})};p({type:"CHANGE_COMPILE_STATUS",payload:{compileText:"开始构建",compilePercent:0}}),t.workspace=window.localStorage.getItem("workspace"),console.log(11111111111,JSON.stringify(t.container.initialParams)),null==(a=null==window?void 0:window.api)||a.send("start-debug",{templateJson:t}),D()},onFieldsChange:e=>{const a=window.localStorage.getItem("lastDebugObj");if(console.log(5555555,e,a),a){const t=JSON.parse(a),l=e[0].name[0],n=e[0].value;t[l]=n,window.localStorage.setItem("lastDebugObj",JSON.stringify(t))}else{const a={},t=e[0].name[0],l=e[0].value;a[t]=l,window.localStorage.setItem("lastDebugObj",JSON.stringify(a))}},form:P,initialValues:{pi:a,modules:t,pageId:c}}),o.createElement(g.Item,r(r({},H),{label:"PI",name:"pi"}),o.createElement(b,{placeholder:"请选择PI",filterOption:!1,options:h,loading:u,showSearch:!0,onSearch:U,notFoundContent:u?o.createElement(N,{size:"small"}):null})),o.createElement("div",{className:"select-page-wrapper"},o.createElement("div",{className:"page-label"},"页面数据："),o.createElement(b,{showSearch:!0,placeholder:"请选择应用",optionFilterProp:"children",style:{width:220},onChange:async a=>{const t=await L.get(`pages?applicationId=${a}`);f(t.value),i(a);const l=e?JSON.stringify(r(r({},JSON.parse(e)),{selectedAppId:a})):JSON.stringify({selectedAppId:a});window.localStorage.setItem("lastDebugObj",l),d("")},value:s},S.map((e=>o.createElement(j,{key:e.id,value:e.id},e.name)))),o.createElement("div",{style:{visibility:C.length>0?"visible":"hidden"}},o.createElement(g.Item,r(r({},H),{name:"pageId",label:"",rules:[{required:!0,message:"请填写页面默认参数"}]}),o.createElement(b,{showSearch:!0,placeholder:"请选择页面",optionFilterProp:"children",style:{width:220}},C.map((e=>o.createElement(j,{key:e.id,value:e.id},e.name))))))),o.createElement(g.Item,r(r({},H),{label:"模块",name:"modules"}),o.createElement(b,{placeholder:"请选择模块",options:I,filterOption:!1,showSearch:!0,onSearch:x,mode:"multiple",notFoundContent:u?o.createElement(N,{size:"small"}):null}))))};const J=()=>{const[e,a]=o.useContext(T),[t,l]=o.useState(localStorage.getItem("workspace")||"");return o.useEffect((()=>{var e,a;return null==(e=null==window?void 0:window.api)||e.receive("dirs-selected",(e=>{(null==e?void 0:e.path[0])&&l(null==e?void 0:e.path[0])})),null==(a=null==window?void 0:window.api)||a.receive("workspace-get",(e=>{l(null==e?void 0:e.path),window.localStorage.setItem("workspace",null==e?void 0:e.path)})),J.timeId=setTimeout((()=>{var e;!window.localStorage.getItem("workspace")&&(null==(e=null==window?void 0:window.api)||e.send("get-workspace"))}),0),()=>{J.timeId=null}}),[]),o.createElement(w,{visible:!0,width:800,onOk:()=>{window.localStorage.setItem("workspace",t),a({type:"CHANGE_SETTING_MODAL",payload:!1})},onCancel:()=>a({type:"CHANGE_SETTING_MODAL",payload:!1})},o.createElement("div",{className:"workspace-box"},o.createElement("div",{className:"label"},"工作目录："),o.createElement(h,{className:"workspace",value:t}),o.createElement(A,{className:"change-button",onClick:e=>{var a;null==(a=null==window?void 0:window.api)||a.send("select-dirs")}},"选择目录")))};var B=()=>{var e;const[a,t]=o.useContext(T);return o.useEffect((()=>{(async()=>{window.dbPromise.then((async e=>{const a=await e.getAll("local-materials");t({type:"UPDATE_LOCAL_MATERIALS",payload:a})}))})()}),[]),o.createElement("div",{className:"center-wrapper"},o.createElement("div",{className:"title"},"本地物料"),o.createElement("div",{className:"material-card-wrapper"},null==(e=null==a?void 0:a.localMaterials)?void 0:e.map(((e,a)=>o.createElement(D,{isLocal:!0,data:e,key:a})))))};const F=e=>{const[a,t]=o.useContext(T),[l,n]=o.useState("0"),r=e=>{n(e.target.dataset.key)};return o.useEffect((()=>{var e,a,l;null==(e=null==window?void 0:window.api)||e.receive("CHANGE_COMPILE_STATUS",(e=>{console.log("lalala",e),t({type:"CHANGE_COMPILE_STATUS",payload:e})}));const n=localStorage.getItem("workspace");console.log(111111111,n),n||null==(a=null==window?void 0:window.api)||a.send("get-workspace"),null==(l=null==window?void 0:window.api)||l.receive("workspace-get",(e=>{console.log(123,e),window.localStorage.setItem("workspace",null==e?void 0:e.path)}))}),[]),o.createElement("div",{className:"home-wrapper"},a.debugModalVisible&&o.createElement(V,null),a.materialNewModalVisible&&o.createElement(x,null),a.settingModalVisible&&o.createElement(J,null),o.createElement("div",{className:"container-wrapper"},o.createElement("div",{className:"nav-wrapper"},o.createElement("div",{"data-key":"0",className:"nav-item local-materials "+("0"===l?"active":""),onClick:r}),o.createElement("div",{"data-key":"1",className:"nav-item online-materials "+("1"===l?"active":""),onClick:r})),"0"===l&&o.createElement(B,null),"1"===l&&o.createElement(G,null)))};var $=()=>{const[e,a]=o.useContext(T);return o.createElement("div",{className:"header-wrapper"},o.createElement("div",{className:"navbar-wrapper"},o.createElement("div",{className:"header-item"},"文件"),o.createElement("div",{className:"header-item",onClick:()=>{a({type:"CHANGE_SETTING_MODAL",payload:!0})}},"设置")))},K=()=>{const[e,a]=o.useContext(T);return o.useEffect((()=>{setTimeout((()=>{a({type:"CHANGE_COMPILE_STATUS",payload:{compileText:"",compilePercent:void 0}})}),1e3)}),[100===e.compilePercent]),o.createElement("div",{className:"footer-wrapper"},o.createElement("div",{className:"left"}),o.createElement("div",{className:"right"},e.compilePercent>=0&&o.createElement("div",{className:"compile-status-box"},o.createElement(S,{percent:e.compilePercent,size:"small"})),o.createElement("div",{className:"progress-text"},e.compileText)))},W=()=>{const e=o.useReducer(M,O);return o.createElement(T.Provider,{value:e},o.createElement($,null),o.createElement(_,null,o.createElement(C,null,o.createElement(f,{path:"/",exact:!0,component:F}))),o.createElement(K,null))};window.dbPromise=I("appx-db",1,{upgrade(e){e.createObjectStore("local-materials",{keyPath:"id"})}}),k.render(o.createElement(W,null),document.getElementById("root"));
